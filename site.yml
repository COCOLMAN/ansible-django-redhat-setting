---
- name: 플레이북 튜토리얼
  hosts: ec2-instance1
  become: true
  tasks:
    - name: Add yum nginx repo
      yum_repository:
        name: nginx repo
        description: NGINX repo
        baseurl: http://nginx.org/packages/mainline/centos/7/$basearch/
        gpgcheck: no

    - name: Add yum ius repo
      yum_repository:
        name: ius repo
        description: IUS repo
        baseurl: https://centos7.iuscommunity.org/ius-release.rpm
        gpgcheck: no

    - name: Install git with yum
      yum:
        name: git

    - name: Install dependencies packages 
      yum:
        state:
          present
        name:
          - gcc
          - zlib-devel
          - bzip2
          - bzip2-devel
          - readline-devel
          - openssl-devel
          - sqlite
          - sqlite-devel
          - xz
          - xz-devel
          - libffi-devel

    - name: clone pyenv
      git:
        repo: 'https://github.com/pyenv/pyenv.git'
        dest: /home/{{ ansible_env.SUDO_USER }}/.pyenv

    - name: block in file
      blockinfile:
        path: /home/{{ ansible_env.SUDO_USER }}/.bashrc
        block: |
          export PYENV_ROOT="$HOME/.pyenv"
          export PATH="$PYENV_ROOT/bin:$PATH"
          if command -v pyenv 1>/dev/null 2>&1; then
            eval "$(pyenv init -)"
          fi
          eval "$(pyenv virtualenv-init -)"
          
    - name: clone virtualenv
      git:
        repo: 'https://github.com/pyenv/pyenv-virtualenv.git'
        dest: /home/{{ ansible_env.SUDO_USER }}/.pyenv/plugins/pyenv-virtualenv

    - name: source
      shell: 'source /home/{{ ansible_env.SUDO_USER }}/.bashrc'  

    - name: create pyenv directory
      become: true
      become_method: sudo
      become_user: "{{ ansible_env.SUDO_USER }}"
      file:
        path: /home/ec2-user/.pyenv/versions
        state: directory

    - name: .pyenv permissions
      file:
        path: /home/ec2-user/.pyenv
        recurse: yes
        owner: ec2-user
        group: ec2-user
        state: directory

    - name: pyenv install
      become: yes
      become_user: ec2-user
      shell: . /home/ec2-user/.bashrc && pyenv install 3.7.2

